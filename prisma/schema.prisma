generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  GUEST
  USER
  ADMIN
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum DiscountType {
  PERCENT
  FIXED
}

// ==================== USER & AUTH ====================

model User {
  id            String    @id @default(cuid())
  firebaseUid   String?   @unique
  email         String?   @unique
  password      String?
  name          String?
  phone         String?
  role          UserRole  @default(GUEST)
  guestUuid     String?   @unique
  avatarUrl     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  addresses     Address[]
  orders        Order[]
  cart          CartItem[]
}

// ==================== CATEGORIES ====================

model Category {
  id          String     @id @default(cuid())
  name        String
  nameAr      String?    // Arabic name
  slug        String     @unique
  description String?
  image       String?
  parentId    String?
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  products    Product[]
  sortOrder   Int        @default(0)
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

// ==================== PRODUCTS ====================

model Product {
  id          String           @id @default(cuid())
  name        String
  nameAr      String?          // Arabic name
  slug        String           @unique
  description String           @db.Text
  descriptionAr String?        @db.Text
  price       Decimal          @db.Decimal(10, 2)
  comparePrice Decimal?        @db.Decimal(10, 2) // Original price for discounts
  dimensions  Json?            // {height, width, depth, unit}
  weight      Decimal?         @db.Decimal(10, 2)
  material    String?
  categoryId  String
  category    Category         @relation(fields: [categoryId], references: [id])
  images      ProductImage[]
  variants    ProductVariant[]
  tags        String[]
  isFeatured  Boolean          @default(false)
  isActive    Boolean          @default(true)
  viewCount   Int              @default(0)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model ProductImage {
  id           String  @id @default(cuid())
  productId    String
  product      Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  thumbnailUrl String
  standardUrl  String
  zoomUrl      String
  altText      String?
  isPrimary    Boolean @default(false)
  sortOrder    Int     @default(0)
}

model ProductVariant {
  id          String     @id @default(cuid())
  productId   String
  product     Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  sku         String     @unique
  name        String     // e.g., "Navy Blue / Velvet"
  color       String?
  colorHex    String?
  material    String?
  size        String?
  priceAdj    Decimal    @default(0) @db.Decimal(10, 2)
  stock       Int        @default(0)
  lowStockThreshold Int  @default(5)
  imageUrl    String?
  isActive    Boolean    @default(true)
  
  cartItems   CartItem[]
  orderItems  OrderItem[]
}

// ==================== CART ====================

model CartItem {
  id        String         @id @default(cuid())
  userId    String
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id])
  quantity  Int            @default(1)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  
  @@unique([userId, variantId])
}

// ==================== ADDRESS ====================

model Address {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  label       String?  // "Home", "Office"
  fullName    String
  phone       String
  street      String
  building    String?
  floor       String?
  apartment   String?
  city        String
  governorate String   // Egyptian governorate
  postalCode  String?
  country     String   @default("Egypt")
  lat         Float?
  lng         Float?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ==================== PROMO CODES ====================

model PromoCode {
  id                 String       @id @default(cuid())
  code               String       @unique
  description        String?
  discountType       DiscountType
  discountValue      Decimal      @db.Decimal(10, 2)
  minCartValue       Decimal?     @db.Decimal(10, 2)
  maxDiscountAmount  Decimal?     @db.Decimal(10, 2) // Cap for percent discounts
  maxUses            Int?
  maxUsesPerUser     Int          @default(1)
  currentUses        Int          @default(0)
  excludedCategories String[]     // Array of category IDs
  excludedProducts   String[]     // Array of product IDs
  startsAt           DateTime     @default(now())
  expiresAt          DateTime?
  isActive           Boolean      @default(true)
  createdAt          DateTime     @default(now())
  
  orders             Order[]
}

// ==================== ORDERS ====================

model Order {
  id                String      @id @default(cuid())
  orderNumber       String      @unique
  userId            String
  user              User        @relation(fields: [userId], references: [id])
  status            OrderStatus @default(PENDING)
  
  // Pricing
  subtotal          Decimal     @db.Decimal(10, 2)
  discount          Decimal     @default(0) @db.Decimal(10, 2)
  shippingCost      Decimal     @default(0) @db.Decimal(10, 2)
  total             Decimal     @db.Decimal(10, 2)
  currency          String      @default("EGP")
  
  // Promo
  promoCodeId       String?
  promoCode         PromoCode?  @relation(fields: [promoCodeId], references: [id])
  
  // Shipping Address
  shippingName      String
  shippingPhone     String
  shippingStreet    String
  shippingBuilding  String?
  shippingCity      String
  shippingGovernorate String
  shippingPostalCode String?
  shippingCountry   String      @default("Egypt")
  shippingLat       Float?
  shippingLng       Float?
  
  // Payment (Paymob)
  paymentMethod     String?     // "card", "wallet", "cod"
  paymobOrderId     String?
  paymobTransactionId String?
  isPaid            Boolean     @default(false)
  paidAt            DateTime?
  
  // Tracking
  trackingToken     String      @unique @default(cuid())
  trackingNumber    String?
  trackingUrl       String?
  estimatedDelivery DateTime?
  deliveredAt       DateTime?
  
  // Notes
  customerNote      String?
  adminNote         String?
  
  items             OrderItem[]
  statusHistory     OrderStatusHistory[]
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
}

model OrderItem {
  id          String         @id @default(cuid())
  orderId     String
  order       Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variantId   String
  variant     ProductVariant @relation(fields: [variantId], references: [id])
  productName String         // Snapshot at order time
  variantName String         // Snapshot at order time
  quantity    Int
  unitPrice   Decimal        @db.Decimal(10, 2)
  total       Decimal        @db.Decimal(10, 2)
}

model OrderStatusHistory {
  id        String      @id @default(cuid())
  orderId   String
  order     Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  status    OrderStatus
  note      String?
  createdBy String?     // User ID or "system"
  createdAt DateTime    @default(now())
}

// ==================== HOME LAYOUT ====================

model HomeLayout {
  id        String   @id @default(cuid())
  section   String   // "hero", "category_carousel", "featured", "banner"
  title     String?
  titleAr   String?
  config    Json     // Section-specific configuration
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==================== SITE SETTINGS ====================

model SiteSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt
}
